desc: "09 â€” Core: multi-service, gRPC + ConnectRPC HTTP"
runners:
  greq:
    addr: server:5000
    tls: false
  req: http://server-http:5001
steps:
  grpc_codebased:
    desc: "gRPC: SayHello on CodeBasedService"
    greq:
      codebased.v1.CodeBasedService/SayHello:
        message:
          name: "gRPC"
    test: |
      current.res.status == 0 &&
      current.res.message.message == 'Hello, gRPC!'

  grpc_protobased:
    desc: "gRPC: SayHello on ProtoBasedService"
    greq:
      protobased.v1.ProtoBasedService/SayHello:
        message:
          name: "gRPC"
    test: |
      current.res.status == 0 &&
      current.res.message.message == 'Hello, gRPC!'

  grpc_test_service:
    desc: "gRPC: SlowMethod on TestService (third registered service)"
    greq:
      test.v1.TestService/SlowMethod:
        message:
          delay_ms: 0
    test: |
      current.res.status == 0 &&
      current.res.message.message == 'Completed after 0ms'

  http_say_hello:
    desc: "ConnectRPC HTTP: CodeBased/SayHello via POST"
    req:
      /codebased.v1.CodeBasedService/SayHello:
        post:
          header:
            Content-Type: application/json
          body:
            application/json:
              name: "HTTP"
    test: |
      current.res.status == 200 &&
      current.res.body.message == 'Hello, HTTP!'

  http_slow_method:
    desc: "ConnectRPC HTTP: SlowMethod via POST"
    req:
      /test.v1.TestService/SlowMethod:
        post:
          header:
            Content-Type: application/json
          body:
            application/json:
              delayMs: 0
    test: |
      current.res.status == 200 &&
      current.res.body.message == 'Completed after 0ms'

  grpc_health_overall:
    desc: "gRPC: Health check (protocol extension)"
    greq:
      grpc.health.v1.Health/Check:
        message: {}
    test: |
      current.res.status == 0

  grpc_get_tokens:
    desc: "gRPC: GetTestTokens (verify all services discoverable)"
    greq:
      test.v1.TestService/GetTestTokens:
        message: {}
    test: |
      current.res.status == 0 &&
      current.res.message.user_token != '' &&
      current.res.message.admin_token != ''

  grpc_error:
    desc: "gRPC: ErrorMethod (verify error handling across services)"
    greq:
      test.v1.TestService/ErrorMethod:
        message:
          code: 5
          message: "not found"
    test: |
      current.res.status == 5
