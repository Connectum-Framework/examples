desc: "05 â€” Auth: JWT (valid, invalid, expired, missing)"
runners:
  greq:
    addr: server:5000
    tls: false
steps:
  get_tokens:
    desc: "Get test tokens"
    greq:
      test.v1.TestService/GetTestTokens:
        message: {}
    test: |
      current.res.status == 0 &&
      current.res.message.user_token != '' &&
      current.res.message.expired_token != ''

  # --- CodeBasedService (programmatic rules) ---
  codebased_valid_token:
    desc: "CodeBased/SayGoodbye with valid user token succeeds"
    greq:
      codebased.v1.CodeBasedService/SayGoodbye:
        headers:
          authorization: "Bearer {{ steps.get_tokens.res.message.user_token }}"
        message:
          name: "Alice"
    test: |
      current.res.status == 0 &&
      current.res.message.message contains 'Goodbye, Alice!'

  codebased_missing_token:
    desc: "CodeBased/SayGoodbye without token returns UNAUTHENTICATED"
    greq:
      codebased.v1.CodeBasedService/SayGoodbye:
        message:
          name: "Eve"
    test: |
      current.res.status == 16

  codebased_invalid_token:
    desc: "CodeBased/SayGoodbye with invalid token returns UNAUTHENTICATED"
    greq:
      codebased.v1.CodeBasedService/SayGoodbye:
        headers:
          authorization: "Bearer invalid.jwt.token"
        message:
          name: "Eve"
    test: |
      current.res.status == 16

  codebased_expired_token:
    desc: "CodeBased/SayGoodbye with expired token returns UNAUTHENTICATED"
    greq:
      codebased.v1.CodeBasedService/SayGoodbye:
        headers:
          authorization: "Bearer {{ steps.get_tokens.res.message.expired_token }}"
        message:
          name: "Eve"
    test: |
      current.res.status == 16

  # --- ProtoBasedService (proto options) ---
  protobased_valid_token:
    desc: "ProtoBased/SayGoodbye with valid user token succeeds"
    greq:
      protobased.v1.ProtoBasedService/SayGoodbye:
        headers:
          authorization: "Bearer {{ steps.get_tokens.res.message.user_token }}"
        message:
          name: "Alice"
    test: |
      current.res.status == 0 &&
      current.res.message.message contains 'Goodbye, Alice!'

  protobased_missing_token:
    desc: "ProtoBased/SayGoodbye without token returns UNAUTHENTICATED"
    greq:
      protobased.v1.ProtoBasedService/SayGoodbye:
        message:
          name: "Eve"
    test: |
      current.res.status == 16

  protobased_invalid_token:
    desc: "ProtoBased/SayGoodbye with invalid token returns UNAUTHENTICATED"
    greq:
      protobased.v1.ProtoBasedService/SayGoodbye:
        headers:
          authorization: "Bearer invalid.jwt.token"
        message:
          name: "Eve"
    test: |
      current.res.status == 16

  protobased_expired_token:
    desc: "ProtoBased/SayGoodbye with expired token returns UNAUTHENTICATED"
    greq:
      protobased.v1.ProtoBasedService/SayGoodbye:
        headers:
          authorization: "Bearer {{ steps.get_tokens.res.message.expired_token }}"
        message:
          name: "Eve"
    test: |
      current.res.status == 16
