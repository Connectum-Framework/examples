# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  namespace: connectum
  labels:
    app.kubernetes.io/name: order-service
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: service
    app.kubernetes.io/part-of: connectum
spec:
  replicas: 3
  revisionHistoryLimit: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: order-service
  template:
    metadata:
      labels:
        app.kubernetes.io/name: order-service
        app.kubernetes.io/version: "1.0.0"
      annotations:
        # Force rolling restart on config change
        checksum/config: "{{ include (print .Template.BasePath \"/configmap.yaml\") . | sha256sum }}"
    spec:
      # =====================================================================
      # Security
      # =====================================================================
      serviceAccountName: order-service
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      # =====================================================================
      # Graceful Shutdown
      # =====================================================================
      # Must be >= shutdown.timeout in createServer() options.
      # Connectum default: 30s. Add 5s buffer for SIGTERM delivery.
      terminationGracePeriodSeconds: 35

      # =====================================================================
      # Scheduling
      # =====================================================================
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: order-service

      containers:
        - name: order-service
          image: ghcr.io/mycompany/order-service:1.0.0
          imagePullPolicy: IfNotPresent

          ports:
            - name: grpc
              containerPort: 5000
              protocol: TCP

          # ==================================================================
          # Environment Configuration
          # ==================================================================
          envFrom:
            - configMapRef:
                name: order-service-config

          # ==================================================================
          # TLS Volumes (optional, skip if using Istio mTLS)
          # ==================================================================
          # volumeMounts:
          #   - name: tls-certs
          #     mountPath: /etc/tls
          #     readOnly: true
          # env:
          #   - name: TLS_CERT_PATH
          #     value: /etc/tls/tls.crt
          #   - name: TLS_KEY_PATH
          #     value: /etc/tls/tls.key

          # ==================================================================
          # Resource Limits
          # ==================================================================
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

          # ==================================================================
          # Health Probes
          # ==================================================================

          # Startup probe: gives the service time to initialize.
          # Checked every 5s, up to 12 times (60s max startup time).
          # Until this passes, liveness and readiness probes are not started.
          startupProbe:
            httpGet:
              path: /healthz
              port: grpc
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 12
            timeoutSeconds: 3

          # Liveness probe: is the process alive?
          # If this fails, Kubernetes restarts the pod.
          livenessProbe:
            httpGet:
              path: /healthz
              port: grpc
            periodSeconds: 15
            failureThreshold: 3
            timeoutSeconds: 3

          # Readiness probe: is the service ready to accept traffic?
          # If this fails, the pod is removed from the Service endpoints.
          # Uses /readyz which checks healthcheckManager status.
          readinessProbe:
            httpGet:
              path: /readyz
              port: grpc
            periodSeconds: 10
            failureThreshold: 3
            timeoutSeconds: 3

          # ==================================================================
          # Lifecycle
          # ==================================================================
          lifecycle:
            preStop:
              exec:
                # Allow time for endpoints to de-register before SIGTERM.
                # This prevents in-flight requests from hitting a terminating pod.
                command: ["sh", "-c", "sleep 5"]

      # volumes:
      #   - name: tls-certs
      #     secret:
      #       secretName: order-service-tls
